#!/bin/sh

# This is run once rc has setup /tmp, /etc and /var; it's our
# responsibility to set things up to run.

# Directories
echo "*** Populating /var .."

mkdir -p /var/run/hostapd
mkdir -p /var/log
mkdir -p /var/tmp
mkdir -p /var/db
mkdir -p /var/empty
mkdir -p /var/cron
mkdir -p /var/cron/tabs

echo "*** setting up hostname"
/bin/hostname TEST_AP

# Bring up loopback
echo "*** bringing up loopback .."
/sbin/ifconfig lo0 inet 127.0.0.1/8 up

echo "*** Password/login databases .."
/usr/sbin/pwd_mkdb /etc/master.passwd
/usr/bin/cap_mkdb /etc/login.conf

echo "*** bringing up bridge .."
/sbin/ifconfig bridge0 create 
/sbin/ifconfig bridge0 addm arge0
/sbin/ifconfig bridge0 inet 10.61.8.9/24
/sbin/ifconfig bridge0 up

echo "*** bringing up arge0 .."
/sbin/ifconfig arge0 up

echo "*** bringing up wlan0/hostapd .. "
/sbin/ifconfig wlan0 create wlandev ath0 wlanmode ap
/sbin/ifconfig wlan0 country Australia

# HT/20 - just so I can test 11a coexistance without things
# getting too fruity.
/sbin/ifconfig wlan0 channel 157:ht/20

# disable ampdutx - we just don't support it
# disable amsdu - again, just to be safe
/sbin/ifconfig wlan0 -ampdutx -amsdu

# Allow larger RX A-MPDU burst sizes in hostap mode
/sbin/ifconfig wlan0 ampdulimit 64k

# set the age queue a bit lower, so I get some real performance.
# Figuring out why ampdu_age kills performance when it should
# just be aging out frames is a later problem.
/sbin/sysctl net.wlan.ampdu_age=5

/sbin/ifconfig wlan0 up
/usr/sbin/hostapd -B /etc/hostapd.conf

/sbin/ifconfig bridge0 addm wlan0 -stp wlan0

# Bring up wlan1 - channel 149:a for testing
/sbin/ifconfig wlan1 create wlandev ath1 wlanmode ap
/sbin/ifconfig wlan1 country Australia
/sbin/ifconfig wlan1 channel 149:a
/sbin/ifconfig wlan1 up
/usr/sbin/hostapd -B /etc/hostapd.wlan1.conf

/sbin/ifconfig bridge0 addm wlan1 -stp wlan1

echo "*** inetd"
/usr/sbin/inetd 

echo "*** Done!"
exit 0

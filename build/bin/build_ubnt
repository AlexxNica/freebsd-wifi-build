#!/bin/sh

SCRIPT_NAME="`basename $0`"
SCRIPT_DIR="`dirname $0`"
CUR_DIR="`pwd`"

# suck in the per-device options
CFGNAME=$1
shift
. ${SCRIPT_DIR}/../cfg/${CFGNAME} || exit 1

# include the config variable generation code
. ${SCRIPT_DIR}/../lib/cfg.sh || exit 1

# This builds a redboot system image from the given kernel and MFS.

# The kernel file needs to be padded to a 64k boundary or although the
# mkfwimage tool will accept it, the urescue program in the redboot
# loader won't!

cat ${X_KERNEL} | gzip -9 | dd if=/dev/stdin of=${X_KERNEL}.gz bs=64k conv=sync

# Create a 256k (empty) config file image
dd if=/dev/zero of=/tmp/cfgfs bs=1k count=256

# Filesystem image is created by "build_fsimage"

mkfwimage -B ${UBNT_ARCH} -v ${UBNT_VERSION} -k ${X_KERNEL}.gz \
    -C 262144 -c /tmp/cfgfs -r ${X_FSIMAGE}.uzip \
    -o /tftpboot/${KERNCONF}.initial.img
